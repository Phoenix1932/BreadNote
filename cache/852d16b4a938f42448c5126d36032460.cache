{"Md5-Key":null,"CreatedTime":1639472587,"LastUpdateTime":1639472587,"ExpiredTime":-1,"Value":{"NoteId":"iip8llbk60ddw211114083054","UserId":"9","Content":"# API development skeleton\n\n\u5e2e\u52a9\u4f60\u5feb\u901f\u642d\u5efa API \u9879\u76ee\u9aa8\u67b6\uff0c\u5e76\u6307\u5bfc\u4f60\u5982\u4f55\u4f7f\u7528\u8be5\u9aa8\u67b6\u7684\u7ec6\u8282\uff0c\u9aa8\u67b6\u9ed8\u8ba4\u5f00\u542f\u4e86 SQL\u3001Redis \u65e5\u5fd7\uff0c\u538b\u6d4b\u524d\u8bf7\u5148\u5173\u95ed `.env` \u7684 `APP_DEBUG`\n\n## \u5b89\u88c5\n\n> \u9700\u8981\u5148\u5b89\u88c5 [Swoole](https:\/\/wiki.swoole.com\/#\/environment) \u6216\u8005 [WorkerMan](http:\/\/doc.workerman.net\/install\/requirement.html)\n\n```\ncomposer create-project --prefer-dist mix\/api-skeleton api\n```\n\n## \u5feb\u901f\u5f00\u59cb\n\n\u542f\u52a8 [cli-server](https:\/\/www.php.net\/manual\/zh\/features.commandline.webserver.php) \u5f00\u53d1\u670d\u52a1 (\u96f6\u4f9d\u8d56)\n\n```\ncomposer run-script --timeout=0 cliserver:start\n```\n\n\u542f\u52a8 Swoole \u591a\u8fdb\u7a0b\u670d\u52a1\n\n```\ncomposer run-script --timeout=0 swoole:start\n```\n\n\u542f\u52a8 Swoole \u534f\u7a0b\u670d\u52a1\n\n```\ncomposer run-script --timeout=0 swooleco:start\n```\n\n\u542f\u52a8 WorkerMan \u591a\u8fdb\u7a0b\u670d\u52a1\n\n```\ncomposer run-script --timeout=0 workerman:start\n```\n\n## \u6267\u884c\u811a\u672c\n\n- `composer run-script` \u547d\u4ee4\u4e2d\u7684 `--timeout=0` \u53c2\u6570\u662f\u9632\u6b62 composer [\u6267\u884c\u8d85\u65f6](https:\/\/getcomposer.org\/doc\/06-config.md#process-timeout)\n- `composer.json` \u5b9a\u4e49\u4e86\u547d\u4ee4\u6267\u884c\u811a\u672c\uff0c\u5bf9\u5e94\u4e0a\u9762\u7684\u6267\u884c\u547d\u4ee4\n\n```json\n\\\\\\\\\\\\\\\"scripts\\\\\\\\\\\\\\\": {\n    \\\\\\\\\\\\\\\"cliserver:start\\\\\\\\\\\\\\\": \\\\\\\\\\\\\\\"php -S localhost:8000 public\/index.php\\\\\\\\\\\\\\\",\n    \\\\\\\\\\\\\\\"swoole:start\\\\\\\\\\\\\\\": \\\\\\\\\\\\\\\"php bin\/swoole.php\\\\\\\\\\\\\\\",\n    \\\\\\\\\\\\\\\"swooleco:start\\\\\\\\\\\\\\\": \\\\\\\\\\\\\\\"php bin\/swooleco.php\\\\\\\\\\\\\\\",\n    \\\\\\\\\\\\\\\"workerman:start\\\\\\\\\\\\\\\": \\\\\\\\\\\\\\\"php bin\/workerman.php start\\\\\\\\\\\\\\\",\n    \\\\\\\\\\\\\\\"cli:clearcache\\\\\\\\\\\\\\\": \\\\\\\\\\\\\\\"php bin\/cli.php clearcache\\\\\\\\\\\\\\\"\n}\n```\n\n\u5f53\u7136\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4e0b\u9762\u8fd9\u6837\u542f\u52a8\uff0c\u6548\u679c\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f `scripts` \u80fd\u5e2e\u4f60\u8bb0\u5f55\u5230\u5e95\u6709\u54ea\u4e9b\u53ef\u7528\u7684\u547d\u4ee4\uff0c\u540c\u65f6\u5728IDE\u4e2d\u8c03\u8bd5\u66f4\u52a0\u65b9\u4fbf\u3002\n\n```\nphp bin\/swoole.php start\n```\n\n## \u7f16\u5199\u4e00\u4e2a API \u63a5\u53e3\n\n\u9996\u5148\u4fee\u6539\u6839\u76ee\u5f55 `.env` \u6587\u4ef6\u7684\u6570\u636e\u5e93\u4fe1\u606f\n\n\u7136\u540e\u5728 `routes\/index.php` \u5b9a\u4e49\u4e00\u4e2a\u65b0\u7684\u8def\u7531\n\n```php\n$vega->handle(\\\\\\\\\\\\\\'\/users\/{id}\\\\\\\\\\\\\\', [new Users(), \\\\\\\\\\\\\\'index\\\\\\\\\\\\\\'])->methods(\\\\\\\\\\\\\\'GET\\\\\\\\\\\\\\');\n```\n\n\u8def\u7531\u91cc\u4f7f\u7528\u4e86 `Users` \u63a7\u5236\u5668\uff0c\u6211\u4eec\u9700\u8981\u521b\u5efa\u4ed6\n\n- \u5982\u4f55\u914d\u7f6e\u8def\u7531\uff1a[mix\/vega](https:\/\/github.com\/mix-php\/vega#readme)\n- \u5982\u4f55\u8c03\u7528\u6570\u636e\u5e93\uff1a[mix\/database](https:\/\/github.com\/mix-php\/database#readme)\n\n```php\n<?php\n\nnamespace App\\\\\\\\\\\\\\\\Controller;\n\nuse App\\\\\\\\\\\\\\\\Container\\\\\\\\\\\\\\\\DB;\nuse Mix\\\\\\\\\\\\\\\\Vega\\\\\\\\\\\\\\\\Context;\n\nclass Users\n{\n\n    \/**\n     * @param Context $ctx\n     * @throws \\\\\\\\\\\\\\\\Exception\n     *\/\n    public function index(Context $ctx)\n    {\n        $row = DB::instance()->table(\\\\\\\\\\\\\\'users\\\\\\\\\\\\\\')->where(\\\\\\\\\\\\\\'id = ?\\\\\\\\\\\\\\', $ctx->param(\\\\\\\\\\\\\\'id\\\\\\\\\\\\\\'))->first();\n        if (!$row) {\n            throw new \\\\\\\\\\\\\\\\Exception(\\\\\\\\\\\\\\'User not found\\\\\\\\\\\\\\');\n        }\n        $ctx->JSON(200, [\n            \\\\\\\\\\\\\\'code\\\\\\\\\\\\\\' => 0,\n            \\\\\\\\\\\\\\'message\\\\\\\\\\\\\\' => \\\\\\\\\\\\\\'ok\\\\\\\\\\\\\\',\n            \\\\\\\\\\\\\\'data\\\\\\\\\\\\\\' => $row\n        ]);\n    }\n\n}\n```\n\n\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u5668\u540e\u65b9\u53ef\u6d4b\u8bd5\u65b0\u5f00\u53d1\u7684\u63a5\u53e3\n\n> \u5b9e\u9645\u5f00\u53d1\u4e2d\u4f7f\u7528 PhpStorm \u7684 Run \u529f\u80fd\uff0c\u53ea\u9700\u8981\u70b9\u51fb\u4e00\u4e0b\u91cd\u542f\u6309\u94ae\u5373\u53ef\n\n```\n\/\/ \u67e5\u627e\u8fdb\u7a0b PID\nps -ef | grep swoole\n\n\/\/ \u901a\u8fc7 PID \u505c\u6b62\u8fdb\u7a0b\nkill PID\n\n\/\/ \u91cd\u65b0\u542f\u52a8\u8fdb\u7a0b\ncomposer run-script swoole:start\n\n\/\/ curl \u6d4b\u8bd5\ncurl http:\/\/127.0.0.1:9501\/users\/1\n```\n\n## \u4f7f\u7528\u5bb9\u5668\u4e2d\u7684\u5bf9\u8c61\n\n\u5bb9\u5668\u91c7\u7528\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u5355\u4f8b\u6a21\u5f0f\uff0c\u4f60\u53ef\u4ee5\u4fee\u6539\u4e3a\u66f4\u52a0\u9002\u5408\u81ea\u5df1\u7684\u65b9\u5f0f\u3002\n\n- \u6570\u636e\u5e93\uff1a[mix\/database](https:\/\/github.com\/mix-php\/database#readme)\n\n```\nDB::instance()\n```\n\n- Redis\uff1a[mix\/redis](https:\/\/github.com\/mix-php\/redis#readme)\n\n```\nRDS::instance()\n```\n\n- \u65e5\u5fd7\uff1a[monolog\/monolog](https:\/\/seldaek.github.io\/monolog\/doc\/01-usage.html)\n\n```\nLogger::instance()\n```\n\n- \u914d\u7f6e\uff1a[hassankhan\/config](https:\/\/github.com\/hassankhan\/config#getting-values)\n\n```\nConfig::instance()\n```\n\n## \u90e8\u7f72\n\n- CLI\n\n\u7ebf\u4e0a\u90e8\u7f72\u542f\u52a8\u65f6\uff0c\u4fee\u6539 `shell\/server.sh` \u811a\u672c\u4e2d\u7684\u7edd\u5bf9\u8def\u5f84\u548c\u53c2\u6570\n\n```\nphp=\/usr\/local\/bin\/php\nfile=\/project\/bin\/swoole.php\ncmd=start\nnumprocs=1\n```\n\n\u542f\u52a8\u7ba1\u7406\n\n```\nsh shell\/server.sh start\nsh shell\/server.sh stop\nsh shell\/server.sh restart\n```\n\n\u4f7f\u7528 `nginx` \u6216\u8005 `SLB` \u4ee3\u7406\u5230\u670d\u52a1\u5668\u7aef\u53e3\u5373\u53ef\n\n```\nserver {\n    server_name www.domain.com;\n    listen 80;\n\n    location \/ {\n        proxy_http_version 1.1;\n        proxy_set_header Connection \\\\\\\\\\\\\\\"keep-alive\\\\\\\\\\\\\\\";\n        proxy_set_header Host $http_host;\n        proxy_set_header Scheme $scheme;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        if (!-f $request_filename) {\n             proxy_pass http:\/\/127.0.0.1:9501;\n        }\n    }\n}\n```\n\n- PHP-FPM\n\n\u548c Laravel\u3001ThinkPHP \u90e8\u7f72\u65b9\u6cd5\u5b8c\u5168\u4e00\u81f4\uff0c\u5c06 `public\/index.php` \u5728 `nginx` \u914d\u7f6e `rewrite` \u91cd\u5199\u5373\u53ef\n\n```\nserver {\n    server_name www.domain.com;\n    listen 80;\n    root \/data\/project\/public;\n    index index.html index.php;\n\n    location \/ {\n        if (!-e $request_filename) {\n            rewrite ^\/(.*)$ \/index.php\/$1 last;\n        }\n    }\n\n    location ~ ^(.+\\\\\\\\\\\\\\\\.php)(.*)$ {\n        fastcgi_pass 127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\\\\\\\\\\\\\\\.php)(.*)$;\n        fastcgi_param PATH_INFO $fastcgi_path_info;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        include fastcgi_params;\n    }\n}\n```\n\n## License\n\nApache License Version 2.0, http:\/\/www.apache.org\/licenses\/\n"}}